<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeerWise Bill Splitter</title>
    <link rel="icon" type="image/png" href="beer-mug.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Navigation */
        .navbar {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            text-decoration: none;
            color: white;
            transition: transform 0.2s ease;
        }

        .navbar-brand:hover {
            transform: translateY(-1px);
        }

        .navbar-brand img {
            height: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            transition: transform 0.3s ease;
        }

        .navbar-brand:hover img {
            transform: rotate(-10deg);
        }

        .navbar-brand h1 {
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 1px;
            margin: 0;
            background: linear-gradient(to right, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .navbar-tagline {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            font-style: italic;
            display: none;
        }

        @media (min-width: 768px) {
            .navbar-tagline {
                display: block;
            }
        }

        /* Main container */
        .container {
            max-width: 600px;
            margin: 2rem auto;
            background: white;
            border: 2px dashed #333;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Receipt header */
        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #333;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .receipt-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .receipt-date {
            font-size: 0.9rem;
            color: #666;
        }

        /* Section styling */
        .section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            text-decoration: underline;
        }

        /* Input groups */
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .input-group input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            font-family: inherit;
        }

        .input-group button {
            background: #34495e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: inherit;
        }

        .input-group button:hover {
            background: #2c3e50;
        }

        /* People list */
        .people-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .person-tag {
            background: #ecf0f1;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            position: relative;
        }

        .person-tag .remove {
            margin-left: 0.5rem;
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
        }

        /* Food items */
        .food-item {
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #fafafa;
        }

        .food-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .food-name {
            font-weight: bold;
        }

        .food-price {
            font-weight: bold;
            color: #27ae60;
        }

        .food-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .split-type {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .split-type input[type="radio"] {
            margin-right: 0.3rem;
        }

        .people-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .person-checkbox {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
        }

        .unequal-inputs {
            display: none;
            margin-top: 0.5rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .unequal-inputs.show {
            display: flex;
        }

        .unequal-input {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
        }

        .unequal-input input {
            width: 60px;
            padding: 0.2rem;
            border: 1px solid #ddd;
        }

        /* Bill summary */
        .bill-summary {
            border-top: 2px dashed #333;
            padding-top: 1.5rem;
            margin-top: 2rem;
        }

        .person-bill {
            border-bottom: 1px dotted #ccc;
            padding: 1rem 0;
            position: relative;
        }

        .person-bill:last-child {
            border-bottom: none;
        }

        .person-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .person-total {
            font-size: 1.2rem;
            color: #27ae60;
            font-weight: bold;
            position: absolute;
            top: 1rem;
            right: 0;
        }

        .person-items {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.3;
            margin-right: 100px;
        }

        .total-bill {
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #333;
        }

        .btn-select-all {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
        }

        .btn-select-all:hover {
            background: #2980b9;
        }

        .remove-food {
            background: transparent;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            padding: 0.3rem;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-food:hover {
            background: #e74c3c;
            color: white;
        }

        .remove-food svg {
            width: 14px;
            height: 14px;
        }

        .bill-title-container {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .bill-title-label {
            color: #666;
            margin-right: 0.5rem;
            font-size: 1rem;
            font-weight: normal;
            vertical-align: middle;
        }

        .bill-title-input {
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            border: none;
            background: transparent;
            width: 60%;
            font-family: inherit;
            color: inherit;
            padding: 0.2rem;
        }

        .bill-title-input:focus {
            outline: 1px dashed #333;
        }

        .bill-title-input::placeholder {
            color: #999;
            font-weight: normal;
        }

        .bill-date-input {
            font-size: 0.9rem;
            color: #666;
            border: none;
            background: transparent;
            text-align: center;
            width: 100%;
            font-family: inherit;
        }

        .bill-date-input:focus {
            outline: 1px dashed #333;
            padding: 0.2rem;
        }

        .paid-by-container {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .paid-by-container label {
            color: #666;
            margin-right: 0.5rem;
        }

        .paid-by-input {
            font-size: 0.9rem;
            color: #333;
            border: none;
            background: transparent;
            text-align: center;
            font-family: inherit;
            width: 200px;
            padding: 0.2rem;
        }

        .paid-by-input:focus {
            outline: 1px dashed #333;
        }

        .paid-by-input::placeholder {
            color: #999;
        }

        .food-header .remove-food {
            cursor: pointer;
        }

        /* Hide the calendar icon in Chrome, Safari, Edge, Opera */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }

        /* Hide the calendar icon in Firefox */
        input[type="date"]::-moz-calendar-picker-indicator {
            display: none;
        }

        /* Hide the calendar icon in Edge (old) and IE */
        input[type="date"]::-ms-clear,
        input[type="date"]::-ms-expand {
            display: none;
        }

        .download-button {
            background: transparent;
            color: #34495e;
            border: 1px solid #34495e;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            margin: 0;
            width: auto;
        }

        .download-button:hover {
            background: #34495e;
            color: white;
        }

        .download-button.whatsapp {
            background: #25D366;
            color: white;
            border: none;
        }

        .download-button.whatsapp:hover {
            background: #1fa855;
        }

        .download-button svg {
            width: 16px;
            height: 16px;
        }

        /* Receipt image styling */
        .receipt-image {
            position: relative;
            width: 300px; /* Narrow like a receipt */
            background: white;
            border: 2px dashed #333;
            padding: 1rem 1rem 1.5rem 1rem; /* Increased bottom padding for zigzag */
            margin: 0 auto;
            font-family: 'Courier New', monospace;
            color: #000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            clip-path: polygon(
                0% 0%, 100% 0%, 100% calc(100% - 10px), /* Top and sides */
                95% 100%, 90% calc(100% - 10px), 85% 100%, 80% calc(100% - 10px), /* Zigzag points */
                75% 100%, 70% calc(100% - 10px), 65% 100%, 60% calc(100% - 10px),
                55% 100%, 50% calc(100% - 10px), 45% 100%, 40% calc(100% - 10px),
                35% 100%, 30% calc(100% - 10px), 25% 100%, 20% calc(100% - 10px),
                15% 100%, 10% calc(100% - 10px), 5% 100%, 0% calc(100% - 10px) /* Finish zigzag */
            );
        }

        .receipt-content {
            text-align: center;
        }

        .receipt-logo {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .receipt-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .receipt-date, .receipt-paid-by {
            font-size: 0.8rem;
            color: #333;
            margin-bottom: 0.3rem;
        }

        .receipt-divider {
            font-size: 0.8rem;
            color: #333;
            margin: 0.5rem 0;
        }

        .receipt-section-title {
            font-size: 1rem;
            font-weight: bold;
            margin: 0.5rem 0;
            text-decoration: underline;
        }

        .receipt-person-bill {
            text-align: left;
            font-size: 0.8rem;
            margin: 0.5rem 0;
            border-bottom: 1px dotted #333;
            padding-bottom: 0.5rem;
        }

        .receipt-person-name {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .receipt-person-items {
            color: #333;
            line-height: 1.2;
            margin-bottom: 0.2rem;
        }

        .receipt-person-total {
            font-weight: bold;
            text-align: right;
        }

        .receipt-total {
            font-size: 1rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <a href="#" class="navbar-brand">
            <img src="beer-mug.png" alt="Beer Mug">
            <h1>beerwise</h1>
        </a>
        <span class="navbar-tagline">Your bill splitting solution</span>
    </nav>

    <div class="container">
        <div class="receipt-header">
            <div class="bill-title-container">
                <input type="text" id="billTitle" class="bill-title-input" placeholder="Enter bill title" />
            </div>
            <input type="date" id="billDate" class="bill-date-input" />
            <div class="paid-by-container">
                <label for="paidBy">Paid By:</label>
                <input type="text" id="paidBy" class="paid-by-input" placeholder="Enter payer's name" />
            </div>
        </div>

        <div class="section">
            <div class="section-title">Add People</div>
            <div class="input-group">
                <input type="text" id="personInput" placeholder="Enter person's name" />
                <button onclick="addPerson()">Add</button>
            </div>
            <div class="people-list" id="peopleList"></div>
        </div>

        <div class="section">
            <div class="section-title">Add Food Items</div>
            <div class="input-group">
                <input type="text" id="foodNameInput" placeholder="Food item name" />
                <input type="number" id="foodPriceInput" placeholder="Price" step="0.01" />
                <button onclick="addFood()">Add</button>
            </div>
            <div id="foodList"></div>
        </div>

        <div class="bill-summary" id="billSummary">
            <div class="section-title">BILL SUMMARY</div>
            <div id="personBills"></div>
            <div class="total-bill" id="totalBill">TOTAL: $0.00</div>
        </div>

        <!-- Hidden receipt for PNG generation -->
        <div id="receiptForImage" class="receipt-image" style="display: none;">
            <div class="receipt-content">
                <div class="receipt-logo">
                    <img src="beer-mug.png" alt="Beer Mug" style="height: 1.2em; vertical-align: middle; margin-right: 0.3em;">
                    beerwise
                </div>
                <div class="receipt-title" id="imageBillTitle"></div>
                <div class="receipt-date" id="imageBillDate"></div>
                <div class="receipt-paid-by" id="imagePaidBy"></div>
                <div class="receipt-divider">--------------------------------</div>
                <div class="receipt-section-title">BILL SUMMARY</div>
                <div id="imagePersonBills"></div>
                <div class="receipt-divider">--------------------------------</div>
                <div class="receipt-total" id="imageTotalBill"></div>
            </div>
        </div>

        <!-- Add Download and Share buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
            <button id="downloadBillPng" class="download-button" onclick="downloadBillAsPng()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Download Bill
            </button>
            <button id="shareWhatsApp" class="download-button whatsapp" onclick="shareOnWhatsApp()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                Share on WhatsApp
            </button>
        </div>
    </div>

    <script>
        let people = [];
        let foodItems = [];
        let openFoodId = null;

        // Set current date
        const dateInput = document.getElementById('billDate');
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0];

        // Add event listeners for title and date changes
        document.getElementById('billTitle').addEventListener('input', function(e) {
            // Optional: Add any validation or formatting logic here
        });

        document.getElementById('billDate').addEventListener('change', function(e) {
            // Optional: Add any date validation or formatting logic here
        });

        // Add person
        function addPerson() {
            const input = document.getElementById('personInput');
            const name = input.value.trim();
            if (name && !people.includes(name)) {
                people.push(name);
                input.value = '';
                renderPeople();
                renderFood();
                calculateBill();
            }
        }

        // Remove person
        function removePerson(name) {
            people = people.filter(p => p !== name);
            // Remove person from all food items
            foodItems.forEach(item => {
                item.people = item.people.filter(p => p !== name);
                if (item.unequalSplit) {
                    delete item.unequalAmounts[name];
                }
            });
            renderPeople();
            renderFood();
            calculateBill();
        }

        // Render people list
        function renderPeople() {
            const container = document.getElementById('peopleList');
            container.innerHTML = people.map(person => 
                `<div class="person-tag">
                    ${person}
                    <span class="remove" onclick="removePerson('${person}')">&times;</span>
                </div>`
            ).join('');
        }

        // Add food item
        function addFood() {
            const nameInput = document.getElementById('foodNameInput');
            const priceInput = document.getElementById('foodPriceInput');
            
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            
            if (name && price > 0) {
                const newFood = {
                    id: Date.now(),
                    name: name,
                    price: price,
                    people: [],
                    equalSplit: true,
                    unequalAmounts: {}
                };
                foodItems.push(newFood);
                openFoodId = newFood.id;
                
                nameInput.value = '';
                priceInput.value = '';
                renderFood();
                calculateBill();
            }
        }

        // Remove food item
        function removeFood(id) {
            foodItems = foodItems.filter(item => item.id !== id);
            renderFood();
            calculateBill();
        }

        // Toggle person for food item
        function togglePersonForFood(foodId, person) {
            const food = foodItems.find(f => f.id === foodId);
            if (food.people.includes(person)) {
                food.people = food.people.filter(p => p !== person);
                delete food.unequalAmounts[person];
            } else {
                food.people.push(person);
                if (!food.equalSplit) {
                    food.unequalAmounts[person] = 0;
                }
            }
            renderFood();
            calculateBill();
        }

        // Select all people for food item
        function selectAllForFood(foodId) {
            const food = foodItems.find(f => f.id === foodId);
            food.people = [...people];
            if (!food.equalSplit) {
                people.forEach(person => {
                    food.unequalAmounts[person] = 0;
                });
            }
            renderFood();
            calculateBill();
        }

        // Toggle split type
        function toggleSplitType(foodId, isEqual) {
            const food = foodItems.find(f => f.id === foodId);
            food.equalSplit = isEqual;
            if (isEqual) {
                food.unequalAmounts = {};
            } else {
                food.people.forEach(person => {
                    food.unequalAmounts[person] = food.unequalAmounts[person] || 0;
                });
            }
            renderFood();
            calculateBill();
        }

        // Update unequal amount
        function updateUnequalAmount(foodId, person, amount) {
            const food = foodItems.find(f => f.id === foodId);
            food.unequalAmounts[person] = parseFloat(amount) || 0;
            calculateBill();
        }

        // Toggle all people for food item
        function toggleAllPeopleForFood(foodId, checked) {
            const food = foodItems.find(f => f.id === foodId);
            if (checked) {
                food.people = [...people];
                if (!food.equalSplit) {
                    people.forEach(person => {
                        food.unequalAmounts[person] = food.unequalAmounts[person] || 0;
                    });
                }
            } else {
                food.people = [];
                food.unequalAmounts = {};
            }
            renderFood();
            calculateBill();
        }

        // Render food items
        function renderFood() {
            const container = document.getElementById('foodList');
            container.innerHTML = foodItems.map(food => {
                const isOpen = openFoodId === food.id;
                return `
                    <div class="food-item" data-food-id="${food.id}">
                        <div class="food-header">
                            <span class="food-name">${food.name}</span>
                            <span class="food-price">$${food.price.toFixed(2)}</span>
                            <button class="remove-food" onclick="removeFood(${food.id})" title="Remove">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </button>
                        </div>
                        ${isOpen ? `
                        <div class="food-controls">
                            <div class="split-type">
                                <label>
                                    <input type="radio" name="split_${food.id}" ${food.equalSplit ? 'checked' : ''} 
                                           onchange="toggleSplitType(${food.id}, true)">
                                    Equal Split
                                </label>
                                <label>
                                    <input type="radio" name="split_${food.id}" ${!food.equalSplit ? 'checked' : ''} 
                                           onchange="toggleSplitType(${food.id}, false)">
                                    Unequal Split
                                </label>
                            </div>
                        </div>
                        <div class="people-selection">
                            <label class="person-checkbox">
                                <input type="checkbox" 
                                    ${food.people.length === people.length && people.length > 0 ? 'checked' : ''}
                                    onchange="toggleAllPeopleForFood(${food.id}, this.checked)">
                                All
                            </label>
                            ${people.map(person => `
                                <label class="person-checkbox">
                                    <input type="checkbox" ${food.people.includes(person) ? 'checked' : ''} 
                                        onchange="togglePersonForFood(${food.id}, '${person}')">
                                    ${person}
                                </label>
                            `).join('')}
                        </div>
                        <div class="unequal-inputs ${!food.equalSplit ? 'show' : ''}">
                            ${food.people.map(person => `
                                <div class="unequal-input">
                                    <span>${person}:</span>
                                    <input type="number" step="0.01" placeholder="0.00" 
                                           value="${food.unequalAmounts[person] || ''}"
                                           onchange="updateUnequalAmount(${food.id}, '${person}', this.value)">
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // After rendering, add click event listeners to food headers
            setTimeout(() => {
                document.querySelectorAll('.food-header').forEach(header => {
                    header.addEventListener('click', function(e) {
                        // Prevent opening if clicking the remove button
                        if (e.target.closest('.remove-food')) return;
                        const foodId = Number(header.parentElement.getAttribute('data-food-id'));
                        if (openFoodId !== foodId) {
                            openFoodId = foodId;
                            renderFood();
                        }
                    });
                });
            }, 0);
        }

        // Calculate and render bill
        function calculateBill() {
            const personTotals = {};
            const personItems = {};
            
            // Initialize
            people.forEach(person => {
                personTotals[person] = 0;
                personItems[person] = [];
            });
            
            // Calculate each person's share
            foodItems.forEach(food => {
                if (food.people.length === 0) return;
                
                if (food.equalSplit) {
                    const share = food.price / food.people.length;
                    food.people.forEach(person => {
                        personTotals[person] += share;
                        personItems[person].push(`${food.name} - $${share.toFixed(2)}`);
                    });
                } else {
                    const totalUnequal = Object.values(food.unequalAmounts).reduce((sum, amt) => sum + amt, 0);
                    if (totalUnequal > 0) {
                        Object.entries(food.unequalAmounts).forEach(([person, amount]) => {
                            if (amount > 0) {
                                personTotals[person] += amount;
                                personItems[person].push(`${food.name} - $${amount.toFixed(2)}`);
                            }
                        });
                    }
                }
            });
            
            // Render bill summary
            const billContainer = document.getElementById('personBills');
            billContainer.innerHTML = people.map(person => `
                <div class="person-bill">
                    <div class="person-name">${person}</div>
                    <div class="person-total">$${personTotals[person].toFixed(2)}</div>
                    <div class="person-items">${personItems[person].join('<br>')}</div>
                </div>
            `).join('');
            
            // Total bill
            const total = Object.values(personTotals).reduce((sum, amt) => sum + amt, 0);
            document.getElementById('totalBill').textContent = `TOTAL: $${total.toFixed(2)}`;
        }

        // Enter key handlers
        document.getElementById('personInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addPerson();
        });

        document.getElementById('foodNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('foodPriceInput').focus();
        });

        document.getElementById('foodPriceInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addFood();
        });

        // Add this with the other event listeners
        document.getElementById('paidBy').addEventListener('input', function(e) {
            // Optional: Add any validation or formatting logic here
        });

        // Listen for clicks to collapse open food when clicking outside
        document.addEventListener('mousedown', function(event) {
            // If no food is open, do nothing
            if (openFoodId === null) return;

            // Find the open food element
            const openFoodElem = document.querySelector(`.food-item[data-food-id='${openFoodId}']`);
            if (!openFoodElem) return;

            // If the click is inside the open food, do nothing
            if (openFoodElem.contains(event.target)) return;

            // Otherwise, collapse it
            openFoodId = null;
            renderFood();
        });

        async function shareOnWhatsApp() {
            const billTitle = document.getElementById('billTitle').value || 'Untitled Bill';
            const billDate = document.getElementById('billDate').value;
            
            // Format date
            const formattedDate = new Date(billDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Generate the image first
            const receiptElement = document.getElementById('receiptForImage');
            receiptElement.style.display = 'block';
            
            try {
                const canvas = await html2canvas(receiptElement, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                
                // Convert canvas to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                // Create a File object
                const file = new File([blob], 'bill.png', { type: 'image/png' });
                
                // Create share text
                const shareText = `Here's the split from "${billTitle}" on ${formattedDate} generated by beerwise`;
                
                // Check if Web Share API is available
                if (navigator.share) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'BeerWise Bill Split',
                            text: shareText
                        });
                    } catch (err) {
                        // Fallback to WhatsApp Web if share fails
                        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
                        window.open(whatsappUrl, '_blank');
                    }
                } else {
                    // Fallback to WhatsApp Web
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
                    window.open(whatsappUrl, '_blank');
                }
            } catch (error) {
                console.error('Error sharing:', error);
                alert('Failed to share. Please try again.');
            } finally {
                receiptElement.style.display = 'none';
            }
        }

        // Modify the existing downloadBillAsPng function to return the canvas
        async function downloadBillAsPng() {
            const billTitle = document.getElementById('billTitle').value || 'Untitled Bill';
            const billDate = document.getElementById('billDate').value;
            const paidBy = document.getElementById('paidBy').value || 'Not specified';
            
            // Format date
            const formattedDate = new Date(billDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Populate hidden receipt
            document.getElementById('imageBillTitle').textContent = billTitle;
            document.getElementById('imageBillDate').textContent = `Date: ${formattedDate}`;
            document.getElementById('imagePaidBy').textContent = `Paid By: ${paidBy}`;

            // Render person bills
            const imagePersonBills = document.getElementById('imagePersonBills');
            imagePersonBills.innerHTML = '';
            const personBills = document.querySelectorAll('.person-bill');
            personBills.forEach(bill => {
                const name = bill.querySelector('.person-name').textContent;
                const total = bill.querySelector('.person-total').textContent;
                const items = bill.querySelector('.person-items').textContent;

                const personBillDiv = document.createElement('div');
                personBillDiv.className = 'receipt-person-bill';
                personBillDiv.innerHTML = `
                    <div class="receipt-person-name">${name}</div>
                    <div class="receipt-person-items">${items}</div>
                    <div class="receipt-person-total">Total: ${total}</div>
                `;
                imagePersonBills.appendChild(personBillDiv);
            });

            // Render total
            const totalBill = document.getElementById('totalBill').textContent;
            document.getElementById('imageTotalBill').textContent = totalBill;

            // Use html2canvas to capture the receipt
            const receiptElement = document.getElementById('receiptForImage');
            receiptElement.style.display = 'block';
            
            try {
                const canvas = await html2canvas(receiptElement, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                
                // Convert canvas to PNG and download
                const image = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = image;
                a.download = `${billTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_bill.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error generating PNG:', error);
                alert('Failed to generate PNG. Please try again.');
            } finally {
                receiptElement.style.display = 'none';
            }
        }
    </script>
</body>
</html>